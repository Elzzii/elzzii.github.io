<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>口红颜色可视化</title>
    <style>
        #bg {
            position: fixed;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        #ui {
            display: block;
            position: absolute;
            top: 0%;
            left: 0%;
            padding: 10px 20px;
        }

        #info {
            position: absolute;
            right: 10px;
            bottom: 10px;
        }

        h1 {
            margin: 0%;
            font-size: 22px;
            color: #fff7fb;
        }

        h2 {
            margin: 0%;
            font-size: 16px;
            color: #555;
        }

        h3 {
            margin: 3px 0;
            font-size: 25px;
            color: #d53d49;
        }

        .series-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid white;
            margin-right: 3px;
        }

        .series-color.active {
            width: 20px;
            height: 20px;
        }

        .all {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid white;
            margin-right: 3px;
        }

        .brands {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid white;
            margin-right: 3px;
        }

        .series-of-lipstick {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid white;
            margin-right: 3px;
        }
    </style>
</head>

<body>
    <div style="position: relative; z-index: -1">
        <canvas id="bg"></canvas>
    </div>
    <div id="ui">
        <h2>
            <span id="brand-name"></span>
            <span id="series-name"></span>
        </h2>
        <div id="series-colors"></div>
        <h3 id="lipstick-info">
            <span id="lipstick-id"></span> <span id="lipstick-name"></span>
        </h3>
        <div class="all-select">

        </div>
        <div class="brand-select">

        </div>
        <div class="series-select">

        </div>
    </div>

    <div id="info">
        <h1>口红颜色可视化</h1>
    </div>

    <script type="text/javascript">
        //更改画布颜色
        function draw() {
            var canvas = document.getElementById('bg');
            var item = canvas.getContext('2d');
            style = item.createLinearGradient(0, 0, 1900, 0);
            style.addColorStop(0, '#ffffff');
            style.addColorStop(1, '#000000');
            item.fillStyle = style;
            item.fillRect(0, 0, 1900, 150);
        }
        draw();
    </script>

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/queue.v1.min.js"></script>
    <script>
        //设置宽高内边距
        var width = 1800, height = 870;

        var padding = { top: 50, right: 50, bottom: 50, left: 400 };
        //读取数据
        queue()
            .defer(d3.json, "lipstick.json")
            .await(ready)

        //存储数据数据，读入数据
        var colorList = [];  //color list
        var nameList = [];  //lipstick name list
        var idList = [];  //lipstick id
        var seriesList = [];  //series list
        var seriesNameList = []  //series name list
        var seriesId = [];  //series id
        var brandsNameList = [];  //brand name list
        var brandId = []; //brand id
        var brandDataset = [];  //brand dataset for attribution
        var seriesNameDataset = [];  //series name dataset for attribution
        var seriesPriceDataset = [];  //series price dataset for
        var hsvcolorList = [];
        var positionsofb = [];
        //prepare dataset
        function ready(error, data) {
            data.brands.forEach(function (d, i) {
                //console.log(d.series);
                //console.log(i);
                brandsNameList.push(d.name);
                seriesList.push(d.series);
            })

            for (var i = 0, n = 0; i < seriesList.length; i++) {
                let bid = i;
                for (var j = 0; j < seriesList[i].length; j++) {
                    let seriesName = seriesList[i][j].name;
                    let seriesPrice = seriesList[i][j].price;
                    seriesNameList.push(seriesName);
                    seriesList[i][j].lipsticks.forEach(function (d, i) {
                        colorList.push(d.color);
                        nameList.push(d.name);
                        idList.push(d.id);
                        brandDataset.push(brandsNameList[bid]);
                        seriesNameDataset.push(seriesName);
                        seriesPriceDataset.push(seriesPrice);
                        seriesId.push(j + n);
                        brandId.push(bid);
                        hsvcolorList.push(rgbToHsv(d.color));
                    })
                }
                n += seriesList[i].length;
                positionsofb.push(n);
            }
            console.log(brandDataset);

            var hsvdisList = [];
            for (let i = 0; i < hsvcolorList.length; i++) {
                hsvdisList.push(HsvDis(hsvcolorList[i]))
            }

            //散点随机坐标集合
            var dataset = [];

            for (let i = 0; i < colorList.length; i++) {
                let x = hsvcolorList[i][0] / 360;
                let y = hsvcolorList[i][1] / 100;
                let z = hsvcolorList[i][2] / 100;
                dataset.push([x, y, z]);
            }

            // x轴比例尺
            var xScale = d3.scaleLinear()
                .domain([0, 1])
                .range([padding.left, width - padding.left - padding.right]);


            //y轴比例尺
            var yScale = d3.scaleLinear()
                .domain([1, 0])
                .range([padding.top, height - padding.top - padding.bottom]);

            //z轴比例尺
            var zScale = d3.scaleLinear()
                .domain([0, 1])
                .range([5, 15]);

            //添加svg元素
            var svg = d3.select("body")
                .append('svg')
                .attr('width', width - padding.left)
                .attr("height", height - padding.top)
                .attr("transform", "translate(" + padding.left + "," + padding.top + ")");

            //tips
            svg.append("g").selectAll(".tips")
                .data(dataset)
                .enter()
                .append("text")
                .attr("class", "tips")
                .attr("x", function (d) {
                    return xScale(d[0]);
                })
                .attr("y", function (d) {
                    return yScale(d[1]);
                })
                .attr("dy", 25)
                .attr("lipstick-id", function (d, i) {
                    return idList[i];
                })
                .attr("series-id", function (d, i) {
                    return seriesId[i];
                })
                .text(function (d, i) {
                    return nameList[i];
                })
                .style("font-size", 11)
                .style("fill", "#000000")
                .style("opacity", 1)
                .style("display", "none")
                .style("text-anchor", "middle");

            //绘制散点图，显示口红颜色
            svg.select('g')
                .selectAll('circle')
                .data(dataset)
                .enter()
                .append('circle')
                .attr("cx", function (d) {
                    return xScale(d[0]);
                })
                .attr("cy", function (d) {
                    return yScale(d[1]);
                })
                .attr("r", function (d) {
                    return zScale(d[2]);
                })
                .attr("fill", function (d, i) {
                    return colorList[i];
                })
                .style("opacity", 1)
                .attr("lipstick-id", function (d, i) {
                    return idList[i];
                })
                .attr("brand-name", function (d, i) {
                    return brandDataset[i];
                })
                .attr("brand-id", function (d, i) {
                    return brandId[i];
                })
                .attr("series-name", function (d, i) {
                    return seriesNameDataset[i];
                })
                .attr("series-id", function (d, i) {
                    return seriesId[i];
                })
                .attr("circle-r", function (d) {
                    return d[2];
                })
                .text(function (d, i) {
                    return nameList[i];
                })
                .on("mouseover", function () {
                    //获得口红的品牌，所属系列，口红id和口红名称
                    var brand = d3.select("#brand-name");
                    var series = d3.select("#series-name");
                    var id = d3.select("#lipstick-id");
                    var name = d3.select("#lipstick-name");
                    brand.text(d3.select(this).attr("brand-name"));
                    series.text(d3.select(this).attr("series-name"));
                    id.text(d3.select(this).attr("lipstick-id"));
                    name.text(d3.select(this).text());

                    //获得当前口红的所属系列id和口红id，用于系列颜色的检索
                    var colorsList = [];
                    let sid = d3.select(this).attr("series-id");
                    let lid = d3.select(this).attr("lipstick-id");
                    d3.selectAll("circle")
                        .filter(function () {
                            return d3.select(this).attr("series-id") == sid;
                        })
                        .each(function () {
                            d3.select(this).raise();
                            let x = d3.select(this).attr("fill");
                            let y = d3.select(this).attr("lipstick-id") == lid ? 1 : 0;
                            let z = d3.select(this).attr("lipstick-id");
                            let v = d3.select(this).attr("circle-r");
                            let w = d3.select(this).attr("series-id");
                            let u = d3.select(this).attr("brand-id");
                            let t = d3.select(this).text();
                            colorsList.push([x, y, z, v, w, u, t]);
                            if (d3.select(this).attr("lipstick-id") == lid) {
                                //改变圆的大小
                                d3.select(this)
                                    .transition()
                                    .duration(1000)
                                    .attr("r", 50)
                                    .style("opacity", 1);
                            }
                            else {
                                d3.select(this)
                                    .transition()
                                    .duration(1000)
                                    .attr("r", 40)
                                    .style("opacity", 1);
                            }
                        });

                    //tips变化
                    d3.selectAll(".tips")
                        .filter(function () {
                            return d3.select(this).attr("series-id") == sid;
                        })
                        .each(function () {
                            d3.select(this).raise();
                            if (d3.select(this).attr("lipstick-id") == lid) {
                                d3.select(this)
                                    .transition()
                                    .duration(1000)
                                    .attr("dy", 45)
                                    .style("font-size", 18)
                                    .style("display", "block")
                            }
                            else {
                                d3.select(this)
                                    .transition()
                                    .duration(1000)
                                    .attr("dy", 35)
                                    .style("font-size", 18)
                                    .style("display", "block")
                            }
                        });

                    //添加系列颜色展示 先remove 再添加
                    d3.select("#series-colors")
                        .selectAll("div").remove()
                    d3.select("#series-colors")
                        .selectAll("div")
                        .data(colorsList)
                        .enter()
                        .append("div")
                        .attr("color-series-id", function (d) {
                            return d[4];
                        })
                        .attr("circle-r", function (d) {
                            return d[3];
                        })
                        .attr("color-id", function (d) {
                            return d[2];
                        })
                        .attr("color-name", function (d) {
                            return d[6];
                        })
                        .attr("brand-id", function (d) {
                            return d[5];
                        })
                        .attr("class", function (d) {
                            return d[1] == 1 ? "series-color active" : "series-color";
                        })
                        .style("background-color", function (d) {
                            return d[0];
                        })
                        .on("mouseover", function () {
                          //获得口红的品牌，所属系列，口红id和口红名称
                          var brand = d3.select("#brand-name");
                          var series = d3.select("#series-name");
                          var id = d3.select("#lipstick-id");
                          var name = d3.select("#lipstick-name");
                          brand.text(brandsNameList[d3.select(this).attr("brand-id")]);
                          series.text(seriesNameList[d3.select(this).attr("color-series-id")]);
                          id.text(d3.select(this).attr("color-id"));
                          name.text(d3.select(this).attr("color-name"));

                            //改变类名称
                            d3.select("#series-colors")
                                .selectAll("div")
                                .filter(function (d) {
                                    return d3.select(this).attr("class") == "series-color active";
                                })
                                .classed("series-color active", false)
                                .classed("series-color", true);

                            d3.select(this)
                                .classed("series-color", false)
                                .classed("series-color active", true);
                            //圆变化
                            let sid = d3.select(this).attr("color-series-id");
                            let lid = d3.select(this).attr("color-id");
                            d3.selectAll("circle")
                                .filter(function (d) {
                                    return d3.select(this).attr("series-id") == sid;
                                })
                                .each(function (d) {
                                    if (d3.select(this).attr("lipstick-id") == lid) {
                                        d3.select(this)
                                            .transition()
                                            .duration(1000)
                                            .attr("r", 50)
                                            .style("opacity", 1);
                                    }
                                    else {
                                        d3.select(this)
                                            .transition()
                                            .duration(1000)
                                            .attr("r", 40)
                                            .style("opacity", 1);
                                    }
                                });
                            //tips变化
                            d3.selectAll(".tips")
                                .filter(function (d) {
                                    return d3.select(this).attr("series-id") == sid;
                                })
                                .each(function (d) {
                                    if (d3.select(this).attr("lipstick-id") == lid) {
                                        d3.select(this)
                                            .transition()
                                            .duration(1000)
                                            .attr("dy", 45)
                                            .style("font-size", 18)
                                            .style("display", "block")
                                    }
                                    else {
                                        d3.select(this)
                                            .transition()
                                            .duration(1000)
                                            .attr("dy", 35)
                                            .style("font-size", 18)
                                            .style("display", "block")
                                    }
                                });
                        })
                        .on("mouseout", function () {
                            //recover
                            let sid = d3.select(this).attr("color-series-id");

                            d3.selectAll("circle")
                                .filter(function (d) {
                                    return d3.select(this).attr("series-id") == sid;
                                })
                                .each(function (d) {
                                    d3.select(this)
                                        .transition()
                                        .duration(1000)
                                        .attr("r", zScale(d3.select(this).attr("circle-r")))
                                        .style("opacity", 1);
                                });

                            //tips recover
                            d3.selectAll(".tips")
                                .filter(function (d) {
                                    return d3.select(this).attr("series-id") == sid;
                                })
                                .each(function (d) {
                                    d3.select(this)
                                        .transition()
                                        .duration(1000)
                                        .attr("dy", 25)
                                        .style("font-size", 11)
                                        .style("display", "none");
                                });
                        });

                    //append button
                    d3.select(".com-button").remove();
                    d3.select("#series-colors")
                        .append("button")
                        .attr("class", "com-button")
                        .text("比较")
                        .on("click", function () {

                        })
                })
                .on("mouseout", function () {
                    //recover
                    sid = d3.select(this).attr("series-id");
                    d3.selectAll("circle")
                        .filter(function (d) {
                            return d3.select(this).attr("series-id") == sid;
                        })
                        .each(function (d) {
                            d3.select(this)
                                .transition()
                                .duration(1000)
                                .attr("r", zScale(d3.select(this).attr("circle-r")))
                                .style("opacity", 1);
                        });

                    //tips recover
                    d3.selectAll(".tips")
                        .filter(function (d) {
                            return d3.select(this).attr("series-id") == sid;
                        })
                        .each(function (d) {
                            d3.select(this)
                                .transition()
                                .duration(1000)
                                .attr("dy", 25)
                                .style("font-size", 11)
                                .style("display", "none");
                        });
                });

            d3.select(".all-select")
                .append("div")
                .classed("all", true)
                .style("background-color", "#ffff00")
                .on("click", function () {
                    d3.selectAll("circle")
                        .each(function () {
                            d3.select(this)
                                .transition()
                                .duration(1000)
                                .style("display", "block")
                                .style("opacity", 1)
                        })
                })

            d3.select(".brand-select")
                .selectAll(".brands")
                .data(brandsNameList)
                .enter()
                .append("div")
                .classed("brands", true)
                .attr("brand-id", function (d, i) {
                    return i
                })
                .attr("brand-name", function (d) {
                    return d
                })
                .style("background-color", "#ff00ff")
                .on("click", function () {
                    d3.select(".series-select")
                        .selectAll("div").remove()

                    let num = d3.select(this).attr("brand-id")
                    let data = []
                    let start = num == 0 ? 0 : positionsofb[num - 1]
                    for (let i = start; i < positionsofb[num]; i++) {
                        data.push([i, seriesNameList[i]])
                    }

                    d3.select(".series-select")
                        .selectAll(".series-of-lipstick")
                        .data(data)
                        .enter()
                        .append("div")
                        .classed("series-of-lipstick", true)
                        .attr("series-id", function (d) {
                            return d[0]
                        })
                        .attr("series-name", function (d) {
                            return d[1]
                        })
                        .style("background-color", "#00ffff")
                        .on("click", function () {
                            let sid = d3.select(this).attr("series-id")
                            let sData = []
                            circles = d3.selectAll("circle")
                                .each(function () {
                                    d3.select(this)
                                        .transition()
                                        .duration(1000)
                                        .style("display", "none")
                                        .style("opacity", 0)
                                })
                                .filter(function () {
                                    return d3.select(this).attr("series-id") == sid;
                                })
                                .each(function () {
                                    let x = d3.select(this).attr("fill");
                                    let y = d3.select(this).attr("lipstick-id");
                                    let z = d3.select(this).attr("circle-r");
                                    let w = d3.select(this).text()
                                    sData.push([x, y, z, w]);
                                    d3.select(this)
                                        .transition()
                                        .duration(1000)
                                        .style("display", "block")
                                        .style("opacity", 1)
                                });

                              d3.select("#series-colors")
                                  .selectAll("div").remove()
                              d3.select("#series-colors")
                                  .selectAll("div")
                                  .data(sData)
                                  .enter()
                                  .append("div")
                                  .attr("class", function (d, i) {
                                      return i == 0 ? "series-color active" : "series-color"
                                  })
                                  .attr("color-series-id", sid)
                                  .attr("circle-r", function (d) {
                                      return d[2]
                                  })
                                  .attr("color-id", function (d) {
                                      return d[1]
                                  })
                                  .attr("color-name", function (d) {
                                      return d[3]
                                  })
                                  .style("background-color", function (d) {
                                      return d[0]
                                  })
                                  .on("mouseover", function () {
                                    //获得口红的品牌，所属系列，口红id和口红名称
                                    var brand = d3.select("#brand-name");
                                    var series = d3.select("#series-name");
                                    var id = d3.select("#lipstick-id");
                                    var name = d3.select("#lipstick-name");
                                    brand.text(brandsNameList[num]);
                                    series.text(seriesNameList[d3.select(this).attr("color-series-id")]);
                                    id.text(d3.select(this).attr("color-id"));
                                    name.text(d3.select(this).attr("color-name"));

                                      //改变类名称
                                      d3.select("#series-colors")
                                          .selectAll("div")
                                          .filter(function (d) {
                                              return d3.select(this).attr("class") == "series-color active";
                                          })
                                          .classed("series-color active", false)
                                          .classed("series-color", true);

                                      d3.select(this)
                                          .classed("series-color", false)
                                          .classed("series-color active", true);
                                      //圆变化
                                      let sid = d3.select(this).attr("color-series-id");
                                      let lid = d3.select(this).attr("color-id");
                                      d3.selectAll("circle")
                                          .filter(function (d) {
                                              return d3.select(this).attr("series-id") == sid;
                                          })
                                          .each(function (d) {
                                              if (d3.select(this).attr("lipstick-id") == lid) {
                                                  d3.select(this)
                                                      .transition()
                                                      .duration(1000)
                                                      .attr("r", 50)
                                                      .style("opacity", 1);
                                              }
                                              else {
                                                  d3.select(this)
                                                      .transition()
                                                      .duration(1000)
                                                      .attr("r", 40)
                                                      .style("opacity", 1);
                                              }
                                          });
                                      //tips变化
                                      d3.selectAll(".tips")
                                          .filter(function (d) {
                                              return d3.select(this).attr("series-id") == sid;
                                          })
                                          .each(function (d) {
                                              if (d3.select(this).attr("lipstick-id") == lid) {
                                                  d3.select(this)
                                                      .transition()
                                                      .duration(1000)
                                                      .attr("dy", 45)
                                                      .style("font-size", 18)
                                                      .style("display", "block")
                                              }
                                              else {
                                                  d3.select(this)
                                                      .transition()
                                                      .duration(1000)
                                                      .attr("dy", 35)
                                                      .style("font-size", 18)
                                                      .style("display", "block")
                                              }
                                          });
                                  })
                                  .on("mouseout", function () {
                                      //recover
                                      let sid = d3.select(this).attr("color-series-id");

                                      d3.selectAll("circle")
                                          .filter(function (d) {
                                              return d3.select(this).attr("series-id") == sid;
                                          })
                                          .each(function (d) {
                                              d3.select(this)
                                                  .transition()
                                                  .duration(1000)
                                                  .attr("r", zScale(d3.select(this).attr("circle-r")))
                                                  .style("opacity", 1);
                                          });

                                      //tips recover
                                      d3.selectAll(".tips")
                                          .filter(function (d) {
                                              return d3.select(this).attr("series-id") == sid;
                                          })
                                          .each(function (d) {
                                              d3.select(this)
                                                  .transition()
                                                  .duration(1000)
                                                  .attr("dy", 25)
                                                  .style("font-size", 11)
                                                  .style("display", "none");
                                          });
                                  });

                                  //append button
                                  d3.select(".com-button").remove();
                                  d3.select("#series-colors")
                                      .append("button")
                                      .attr("class", "com-button")
                                      .text("比较")
                                      .on("click", function () {

                                      })
                        })
                })
        };

        function rgbToHsv(hex) {
            [R, G, B] = htoi(hex)
            R /= 255
            G /= 255
            B /= 255
            const max = Math.max(R, G, B)
            const min = Math.min(R, G, B)
            const range = max - min
            let V = max
            let S = V === 0 ? 0 : range / V
            let H = 0
            if (R === V) H = (60 * (G - B)) / range
            if (G === V) H = 120 + (60 * (B - R)) / range
            if (B === V) H = 240 + (60 * (R - G)) / range

            if (range === 0) H = 0
            if (H < 0) H += 360
            H = (H / 2) * (256 / 180)
            S *= 100
            V *= 100
            return [H, S, V]
        }


        function htoi(hex) {
            s1 = hex.slice(1, 3);
            s2 = hex.slice(3, 5);
            s3 = hex.slice(5);
            a = s1.toLowerCase().charCodeAt(0);
            b = s1.toLowerCase().charCodeAt(1);
            c = s2.toLowerCase().charCodeAt(0);
            d = s2.toLowerCase().charCodeAt(1);
            e = s3.toLowerCase().charCodeAt(0);
            f = s3.toLowerCase().charCodeAt(1);
            return [rgbhtoi(a, b), rgbhtoi(c, d), rgbhtoi(e, f)];
        }

        function rgbhtoi(a, b) {
            if (a > 47 && a < 58) {
                a = (a - 48) * 16;
            }
            else if (a > 96 && a < 103) {
                a = (a - 87) * 16;
            }
            else {
                alert("error");
                return 0;
            }
            if (b > 47 && b < 58) {
                a = a + b - 48;
            }
            else if (b > 96 && b < 103) {
                a = a + b - 87;
            }
            else {
                alert("error");
                return 0;
            }
            return a;
        }

        function HsvDis(hsv) {
            h = hsv[0];
            s = hsv[1];
            v = hsv[2];
            R = 100;
            angle = 30;
            h = R * Math.cos(angle / 180 * Math.PI);
            r = R * Math.sin(angle / 180 * Math.PI);
            x = r * v * s * Math.cos(h / 180 * Math.PI);
            y = r * v * s * Math.sin(h / 180 * Math.PI);
            z = h * (1 - v);
            return Math.sqrt(x * x + y * y + z * z);
        }
    </script>
</body>

</html>
